<!--
  NuGet automatically imports this file into any project that has a PackageReference to 'SampleTasks'.
  To see this in action, execute "dotnet restore" on the 3-NuGet example and look in the obj/ folder for
  a file named Web.csproj.g.nuget.targets. You'll see inside that it contains an "Import" to this file.
 -->
<Project>
    <UsingTask TaskName="ReplaceFileText" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
      <ParameterGroup>
        <InputFilename ParameterType="System.String" Required="true" />
        <OutputFilename ParameterType="System.String" Required="true" />
        <text_replacing ParameterType="System.String" Required="true" />
        <text_replacement ParameterType="System.String" Required="true" />
      </ParameterGroup>
      <Task>
        <Reference Include="System.Core" />
        <Using Namespace="System" />
        <Using Namespace="System.IO" />
        <Using Namespace="System.Text.RegularExpressions" />
        <Code Type="Fragment" Language="cs">
          <![CDATA[
                string content = File.ReadAllText(InputFilename);
                File.WriteAllText
                    (
                        OutputFilename,
                        content
                            .Replace
                                (
                                    text_replacing, 
                                    text_replacement
                                )
                            .Replace
                                (
                                    "////", 
                                    @"\"
                                )
                    );
              ]]>
        </Code>
      </Task>
    </UsingTask>
    
     <UsingTask TaskName="ReplaceFileTextRegex" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
      <ParameterGroup>
        <InputFilename ParameterType="System.String" Required="true" />
        <OutputFilename ParameterType="System.String" Required="true" />
        <MatchExpression ParameterType="System.String" Required="true" />
        <ReplacementText ParameterType="System.String" Required="true" />
      </ParameterGroup>
      <Task>
        <Reference Include="System.Core" />
        <Using Namespace="System" />
        <Using Namespace="System.IO" />
        <Using Namespace="System.Text.RegularExpressions" />
        <Code Type="Fragment" Language="cs">
          <![CDATA[
                File.WriteAllText
                    (
                        OutputFilename,
                        Regex
                            .Replace
                                (
                                    File.ReadAllText(InputFilename), 
                                    MatchExpression, 
                                    ReplacementText
                                )
                    );
              ]]>
        </Code>
      </Task>
    </UsingTask>

    <PropertyGroup>  
        <BindingsHelperFolder>hwolisticware-generated</BindingsHelperFolder>  
        <BindningApiXml>$(IntermediateOutputPath)\api.xml</BindningApiXml>  
    </PropertyGroup>  
     <ItemGroup>
        <BindningSourceFiles Include="$(IntermediateOutputPath)\generated\src\*"></BindningSourceFiles>  
        <Compile Include="$(BindingsHelperFolder)\*.cs" />
    </ItemGroup>
    
    <Target Name="BindingsHelpersClean" AfterTargets="Clean">  
        <Message Text="mc++ AfterTargets=Clean" />  
        <RemoveDir Directories="$(BindingsHelperFolder)" />  
    </Target>
    
    <Target Name="BindingsHelpersPrepare" BeforeTargets="BindningSourceFiles">  
        <Message Text="mc++ AfterTargets=BindningSourceFiles" />  
        <RemoveDir Directories="$(BindingsHelperFolder)" />  
        <Message Text="mc++ BeforeTargets=Compile" />  
        <MakeDir Directories="$(BindingsHelperFolder)" />
        <Copy SourceFiles="$(BindningApiXml)" DestinationFolder="$(BindingsHelperFolder)/" />  
        <CreateItem Include="$(IntermediateOutputPath)\generated\src\*.cs">
          <Output TaskParameter="Include" ItemName="BindingsCSharpFiles"/>
        </CreateItem>
        <Move SourceFiles="@(BindingsCSharpFiles)" DestinationFolder="$(BindingsHelperFolder)\" />

        <Message Text="File = $(IntermediateOutputPath)\generated\src\$(MSBuildProjectName).projitems" />  

        <ReplaceFileText 
            InputFilename="$(IntermediateOutputPath)\generated\src\$(MSBuildProjectName).projitems" 
            OutputFilename="$(IntermediateOutputPath)\generated\src\$(MSBuildProjectName).projitems" 
            text_replacing="MSBuildThisFileDirectory)" 
            text_replacement="MSBuildThisFileDirectory)\\\\..\\\\..\\\\$(BindingsHelperFolder)"
            >            
        </ReplaceFileText>
        
        <CreateItem Include="$(BindingsHelperFolder)\*.cs">
          <Output TaskParameter="Include" ItemName="BindingsCSharpFilesMoved"/>
        </CreateItem>
        <ItemGroup>
            <Folder Include="$(BindingsHelperFolder)" />
            <Compile Include="$(BindingsHelperFolder)\*.cs">
                <Visible>true</Visible>
            </Compile>
        </ItemGroup>
        
    </Target>
</Project>
