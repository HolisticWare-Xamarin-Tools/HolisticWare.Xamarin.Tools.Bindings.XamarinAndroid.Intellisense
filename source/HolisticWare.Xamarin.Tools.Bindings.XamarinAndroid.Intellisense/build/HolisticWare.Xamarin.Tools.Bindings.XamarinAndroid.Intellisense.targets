<!--
  NuGet automatically imports this file into any project that has a PackageReference to 'SampleTasks'.
  To see this in action, execute "dotnet restore" on the 3-NuGet example and look in the obj/ folder for
  a file named Web.csproj.g.nuget.targets. You'll see inside that it contains an "Import" to this file.
 -->
<Project>
    <UsingTask TaskName="ReplaceFileText" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
      <ParameterGroup>
        <InputFilename ParameterType="System.String" Required="true" />
        <OutputFilename ParameterType="System.String" Required="true" />
        <MatchExpression ParameterType="System.String" Required="true" />
        <ReplacementText ParameterType="System.String" Required="true" />
      </ParameterGroup>
      <Task>
        <Reference Include="System.Core" />
        <Using Namespace="System" />
        <Using Namespace="System.IO" />
        <Using Namespace="System.Text.RegularExpressions" />
        <Code Type="Fragment" Language="cs">
          <![CDATA[
                File.WriteAllText
                    (
                        OutputFilename,
                        Regex.Replace
                                (
                                    File.ReadAllText(InputFilename), 
                                    MatchExpression, 
                                    ReplacementText
                                )
                    );
              ]]>
        </Code>
      </Task>
    </UsingTask>
    
    <PropertyGroup>  
        <BindingsHelperFolder>.\hwolisticware-generated\</BindingsHelperFolder>  
        <BindningApiXml>.\obj\$(Configuration)\api.xml</BindningApiXml>  
    </PropertyGroup>  
     <ItemGroup>
        <BindningSourceFiles Include="$(IntermediateOutputPath)\generated\src\*"></BindningSourceFiles>  
        <Compile Include="$(BindingsHelperFolder)\*.cs" />
    </ItemGroup>
    <Target Name="BindingsHelpersClean" AfterTargets="Clean;BeforeBuild">  
        <RemoveDir Directories="$(BindingsHelperFolder)" />  
    </Target>  
    <Target Name="BindingsHelpersPrepare" AfterTargets="BeforeCompile">  
        <MakeDir Directories="$(BindingsHelperFolder)" />
        <Copy SourceFiles="$(BindningApiXml)" DestinationFolder="$(BindingsHelperFolder)/" />  
        <CreateItem Include="$(IntermediateOutputPath)\generated\src\*.cs">
          <Output TaskParameter="Include" ItemName="BindingsCSharpFiles"/>
        </CreateItem>
        <Move SourceFiles="@(BindingsCSharpFiles)" DestinationFolder="$(BindingsHelperFolder)\" />

        <Message Text="File = $(IntermediateOutputPath)\generated\src\$(MSBuildProjectName).projitems" />  

        <ReplaceFileText 
            InputFilename="$(IntermediateOutputPath)\generated\src\$(MSBuildProjectName).projitems" 
            OutputFilename="$(IntermediateOutputPath)\generated\src\$(MSBuildProjectName).projitems" 
            MatchExpression="MSBuildThisFileDirectory" 
            ReplacementText="AAAAAAAAAAAAAAAAAAS"
            >            
        </ReplaceFileText>
    </Target>
  <ItemGroup>
        <Folder Include="$(BindingsHelperFolder)" />
        <Compile Include="$(BindingsHelperFolder)\*.cs">
            <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        </Compile>
  </ItemGroup>
    
</Project>
